---
title: "Naive Bayes Agency Data Predictive Model"
author: "Frank Neugebauer"
date: "9/10/2019"
output:
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(xlsx)
library(dplyr)
library(e1071)
library(caret)
```

# Agency Data Simple Naive Bayes Predictive Model

Agency data intuitively has value to an agency and potentially to agent's carrier partner(s). One way to gain value from that data - which exists within agency management systems - is to create one or more predictive models. Gaining insight from predictive modeling using agency data is the fundamental nature of this effort.

** Prologue **
It's clear that predictive modelling with agency has value. The contents of this analysis are a single perspective of such an effort, although subsequently, at least one other perspective is presented to give the reader a glimpse into how varied this analysis could potentially be.

This uses a largely unalered simple Naive Bayes model to set a baseline for subsequent predictive models, which can be created using other algorithms.

```{r}
# Read the original data set
agency_data_orig <- read.xlsx('./data/AgencyData_clean.xlsx', sheetIndex=1, stringsAsFactors=T)
```

## Data Setup

There are a couple of irrelevant attributes from the original set. Get rid of those and then setup the `train` and `test` data sets.

```{r}
# Trim the phat - i.e., data that's irrelevant
agency_data_used <- agency_data_orig[c(-1, -4)]
str(agency_data_used)

# Setup train and test data, 70% / 30%
train_ad <- sample_frac(agency_data_used, 0.7)
sid <- as.numeric(rownames(train_ad)) # because rownames() returns character
test_ad <- agency_data_used[-sid,]
```

## Build the Model

This step is set aside because with a big data set, it would be slow or put into a distributed system. This model is using `transaction_type` as the target variable. In simple terms, the model is making predictions for the various transaction types given other conditions, such as the line of business.

For example, can the model predict the likelihood of a renewal for a personal auto policy (it can go deeper than that, but it's a good illustration of the principle).

```{r}
nb_model <- naiveBayes(transaction_type~., data=train_ad)
```

## Conditional Probabilities

The model creates the conditional probabilities based on the training data. This output shows those, which is interesting unto itself.

Intuitively, it may appear that this is simple math - e.g., if there were 100 transactions and 40 of them were renewals, then the probability should be 40%. However, this model is multi-factored, which means a more accurate way of considering it is, given the line of business was personal auto, there's some non-obvious probability that a renwal will occur. That's the kind of probabilities being reported here.

```{r echo=FALSE}
nb_model$tables$account_type
```

```{r}
nb_model$tables$assigned_agent
nb_model$tables$lob
nb_model$tables$master_company
#nb_model$tables$effective_date # bin this
nb_model$tables$policy_term
nb_model$tables$policy_type
# create one for binned premium
nb_model$tables$rating_state
nb_model$tables$status
```
 
## Make Predictions

As with the model, this step can take some real time with a large data set, so it's segregated from processing / output.

```{r}
nb_predict <- predict(nb_model, test_ad)
```

## Show the Predictions

This is similar to the conditional probability, but applies it to show the actual predicted values.

```{r}
table(nb_predict, test_ad$account_type)
table(nb_predict, test_ad$assigned_agent)
table(nb_predict, test_ad$lob)
table(nb_predict, test_ad$master_company)
#table(nb_predict, test_ad$effective_date) # bin this
table(nb_predict, test_ad$policy_term)
table(nb_predict, test_ad$policy_type)
table(nb_predict, test_ad$rating_state)
table(nb_predict, test_ad$status)
```

## Confusion Matrix

Build a simple confusion matrix and then plot it.

```{r}
confusion_matrix <- table(nb_predict, test_ad$transaction_type)
plot(confusion_matrix)
```

## Finally, Show Stats on the Confusion Matrix

```{r}
confusionMatrix(confusion_matrix)
```

